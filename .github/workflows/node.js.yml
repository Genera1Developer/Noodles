name: Noodles CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install Dependencies
        run: npm install
      - name: Run Build
        run: npm run build --if-present
      - name: Run Tests
        run: npm test --if-present
      - name: Security Scan
        run: |
          echo "Running security scans... preparing for deployment..."
          # Add SonarQube or other security tools later for real prod usage
          echo "Security scan complete."

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22 # Explicitly defined port
          script: |
            echo "Commencing deployment sequence..."
            cd /var/www/noodles
            echo "Pulling latest code..."
            git pull origin main
            echo "Installing dependencies..."
            npm install
            echo "Building application..."
            npm run build
            echo "Restarting Noodles service..."
            sudo systemctl restart noodles
            echo "Noodles deployed... awaiting carnage!"